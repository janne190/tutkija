name: E2E Nightly
on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
jobs:
  e2e:
    runs-on: ubuntu-latest
    services:
      grobid:
        image: ghcr.io/kermitt2/grobid:latest
        ports:
          - "8070:8070"
    env:
      UNPAYWALL_EMAIL: ${{ secrets.UNPAYWALL_EMAIL }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install uv
        run: pipx install uv
      - name: Setup venv
        run: |
          uv venv
          . .venv/bin/activate
          uv pip install -e ".[dev,parse]"
      - name: Smoke, la hello
        run: |
          . .venv/bin/activate
          la hello | head -n 3

      - name: Live search-all smoke
        env:
          TUTKIJA_CONTACT_EMAIL: ci@tutkija.invalid
        run: |
          set -euo pipefail
          . .venv/bin/activate
          la search-all --topic "genomic screening cancer" --out data/cache/merged.parquet

      - name: Live pdf discover
        run: |
          set -euo pipefail
          . .venv/bin/activate
          la pdf discover --in data/cache/merged.parquet --out data/cache/pdf_index.parquet

      - name: Live pdf download
        run: |
          set -euo pipefail
          . .venv/bin/activate
          la pdf download --in data/cache/pdf_index.parquet --pdf-dir data/pdfs --audit data/logs/pdf_audit.csv --mailto "$UNPAYWALL_EMAIL" --timeout 30 --retries 2 --throttle 200

      - name: Live parse smoke
        run: |
          set -euo pipefail
          . .venv/bin/activate
          la parse run --pdf-dir data/pdfs --out-dir data/parsed --index-out data/cache/parsed_index.parquet --grobid-url http://localhost:8070 --err-log data/logs/parse_errors.csv --sample 20

      - name: Live screen smoke
        run: |
          set -euo pipefail
          . .venv/bin/activate
          la screen --in data/cache/merged.parquet --out data/cache/screened.parquet --recall 0.9
          python scripts/validate_screen_log.py

      - name: Validate pdf/parse outcomes
        run: |
          set -euo pipefail
          . .venv/bin/activate
          python scripts/validate_pdf_parse.py
